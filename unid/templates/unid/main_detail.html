
{% extends 'unid/navigationbar.html' %}
{% load static %}
{% block content %}
<!-- Page Content -->
<link href="{% static 'unid/css/index.css' %}" rel="stylesheet">
<link href="{% static 'unid/css/main_detail.css' %}" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:300,400,500,700&amp;subset=korean" rel="stylesheet">

<style>
ul {
    margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: inherit;
	vertical-align: baseline;
    list-style: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
	content: '';
	content: none;
}
}
.img-replace {
  /* replace text with an image */
  display: inline-block;
  overflow: hidden;
  text-indent: 100%;
  color: transparent;
  white-space: nowrap;
}

.cd-nugget-info {
  text-align: center;
  position: absolute;
  width: 100%;
  height: 50px;
  line-height: 50px;
  bottom: 0;
  left: 0;
}
.cd-nugget-info a {
  position: relative;
  font-size: 14px;
  color: #5e6e8d;
  -webkit-transition: all 0.2s;
  -moz-transition: all 0.2s;
  transition: all 0.2s;
}

.cd-nugget-info span {
  vertical-align: middle;
  display: inline-block;
}
.cd-nugget-info span svg {
  display: block;
}
.cd-nugget-info .cd-nugget-info-arrow {
  fill: #5e6e8d;
}

/* --------------------------------

Main components

-------------------------------- */
header {
  height: 200px;
  line-height: 200px;
  text-align: center;
  background-color: #5e6e8d;
  color: #FFF;
}
header h1 {
  font-size: 20px;
  font-size: 1.25rem;
}

.cd-popup-trigger {
  display: block;
  width: 150px;
  height: 40px;
  /* line-height: 50px; */
  text-align: center;
  color: #FFF;
  font-size: 14px;
  font-size: 0.95rem;
  border-radius: 0.5em;
  background: #fb2323d1;
  box-shadow: 0 3px 0 rgba(0, 0, 0, 0.07);
}
@media only screen and (min-width: 1170px) {
  .cd-popup-trigger {
    margin: 1em auto;
  }
}

/* --------------------------------

xpopup

-------------------------------- */
.cd-popup, .cd-popup1, .cd-popup2{
  position: fixed;
  left: 0;
  top: 0;
  height: 100%;
  width: 100%;
  background-color: rgba(94, 110, 141, 0.9);
  opacity: 0;
  visibility: hidden;
  -webkit-transition: opacity 0.3s 0s, visibility 0s 0.3s;
  -moz-transition: opacity 0.3s 0s, visibility 0s 0.3s;
  transition: opacity 0.3s 0s, visibility 0s 0.3s;
  z-index: 1;
}
.cd-popup.is-visible, .cd-popup1.is-visible, .cd-popup2.is-visible {
  opacity: 1;
  visibility: visible;
  -webkit-transition: opacity 0.3s 0s, visibility 0s 0s;
  -moz-transition: opacity 0.3s 0s, visibility 0s 0s;
  transition: opacity 0.3s 0s, visibility 0s 0s;
}
.cd-popup-container2 {
  position: relative;
  width: 90%;
  max-width: 500px;
  margin: 4em auto;
  background: #FFF;
  border-radius: .25em .25em .4em .4em;
  text-align: center;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
  -webkit-transform: translateY(-40px);
  -moz-transform: translateY(-40px);
  -ms-transform: translateY(-40px);
  -o-transform: translateY(-40px);
  transform: translateY(-40px);
  /* Force Hardware Acceleration in WebKit */
  -webkit-backface-visibility: hidden;
  -webkit-transition-property: -webkit-transform;
  -moz-transition-property: -moz-transform;
  transition-property: transform;
  -webkit-transition-duration: 0.3s;
  -moz-transition-duration: 0.3s;
  transition-duration: 0.3s;
  padding: 30px;
}
.cd-popup-container1 {
  position: relative;
  width: 90%;
  max-width: 500px;
  margin: 4em auto;
  background: #FFF;
  border-radius: .25em .25em .4em .4em;
  text-align: center;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
  -webkit-transform: translateY(-40px);
  -moz-transform: translateY(-40px);
  -ms-transform: translateY(-40px);
  -o-transform: translateY(-40px);
  transform: translateY(-40px);
  /* Force Hardware Acceleration in WebKit */
  -webkit-backface-visibility: hidden;
  -webkit-transition-property: -webkit-transform;
  -moz-transition-property: -moz-transform;
  transition-property: transform;
  -webkit-transition-duration: 0.3s;
  -moz-transition-duration: 0.3s;
  transition-duration: 0.3s;
  padding: 30px;
}
.cd-popup-container {
  position: relative;
  width: 90%;
  max-width: 400px;
  margin: 4em auto;
  background: #FFF;
  border-radius: .25em .25em .4em .4em;
  text-align: center;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
  -webkit-transform: translateY(-40px);
  -moz-transform: translateY(-40px);
  -ms-transform: translateY(-40px);
  -o-transform: translateY(-40px);
  transform: translateY(-40px);
  /* Force Hardware Acceleration in WebKit */
  -webkit-backface-visibility: hidden;
  -webkit-transition-property: -webkit-transform;
  -moz-transition-property: -moz-transform;
  transition-property: transform;
  -webkit-transition-duration: 0.3s;
  -moz-transition-duration: 0.3s;
  transition-duration: 0.3s;
  padding: 30px;
}
.cd-popup-container p, .cd-popup-container1 p, .cd-popup-container2 p{
  padding: 3em 1em;
}
.cd-popup-container .cd-buttons:after, .cd-popup-container1 .cd-buttons:after, .cd-popup-container2 .cd-buttons:after {
  content: "";
  display: table;
  clear: both;
}
.cd-popup-container .cd-buttons li, .cd-popup-container1 .cd-buttons li, .cd-popup-container2 .cd-buttons li {
  float: left;
  width: 50%;
  padding: 5px 20px 10px 20px;
  list-style: none;
}
.cd-popup-container .cd-buttons a, .cd-popup-container1 .cd-buttons a, .cd-popup-container2 .cd-buttons a {
  display: block;
  height: 40px;
  line-height: 40px;
  text-transform: uppercase;
  color: #FFF;
  -webkit-transition: background-color 0.2s;
  -moz-transition: background-color 0.2s;
  transition: background-color 0.2s;
}
.cd-popup-container .cd-buttons li:first-child a, .cd-popup-container1 .cd-buttons li:first-child a, .cd-popup-container2 .cd-buttons li:first-child a {
  background: #b6bece;
  border-radius: 0 0 0 .25em;
}
.popuprow1 {
    font-weight: bold;
    padding: 30px 20px 50px;
}
.popuprow2 {
    color: grey;
    padding: 0 0 30px 0;
    font-size: 0.95rem;
    text-align: left;
}
.popupcategory {
    margin: 0 0 40px 0;
}
.popupcategory label {
    position: relative;
    right: 40px;
}
.popupcategory select {
    float: right;
    position: relative;
    bottom: 10px;
    right: 20px;
}
.popupcategory input {
    display: none;
}
.popuprow3 {
    color: grey;
    padding: 0 0 30px 0;
    font-size: 0.8rem;
}


.cd-popup-container .cd-buttons li:last-child a,
.cd-popup-container1 .cd-buttons li:last-child a,
.cd-popup-container2 .cd-buttons li:last-child a {
  background: #fc7169;
  border-radius: 0 0 .25em 0;
}

.cd-popup-container .cd-popup-close, .cd-popup-container1 .cd-popup-close, .cd-popup-container2 .cd-popup-close {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 30px;
  height: 30px;
}
.cd-popup-container .cd-popup-close::before,
.cd-popup-container .cd-popup-close::after,
.cd-popup-container1 .cd-popup-close::before,
.cd-popup-container1 .cd-popup-close::after,
.cd-popup-container2 .cd-popup-close::before,
.cd-popup-container2 .cd-popup-close::after{
  content: '';
  position: absolute;
  top: 12px;
  width: 14px;
  height: 3px;
  background-color: #8f9cb5;
}
.cd-popup-container .cd-popup-close::before, .cd-popup-container1 .cd-popup-close::before, .cd-popup-container2 .cd-popup-close::before {
  -webkit-transform: rotate(45deg);
  -moz-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  -o-transform: rotate(45deg);
  transform: rotate(45deg);
  left: 8px;
}
.cd-popup-container .cd-popup-close::after, .cd-popup-container1 .cd-popup-close::after, .cd-popup-container2 .cd-popup-close::after {
  -webkit-transform: rotate(-45deg);
  -moz-transform: rotate(-45deg);
  -ms-transform: rotate(-45deg);
  -o-transform: rotate(-45deg);
  transform: rotate(-45deg);
  right: 8px;
}
.is-visible .cd-popup-container, .is-visible .cd-popup-container1, .is-visible .cd-popup-container2 {
  -webkit-transform: translateY(0);
  -moz-transform: translateY(0);
  -ms-transform: translateY(0);
  -o-transform: translateY(0);
  transform: translateY(0);
  color: black;
}
.popupinformationsrow {
    flex-direction: row;
    display: inline;
}
.popupinformations {
    color: black;
    font-weight: bold;
    float: right;
}

@media only screen and (min-width: 1170px) {
  .cd-popup-container {
    margin: 10% auto;
  }
  .cd-popup-container1 {
    margin: 10% auto;
  }
  .cd-popup-container2 {
    margin: 10% auto;
  }

</style>

<div class="container1">
    <!-- contents InFo -->
    <div class="rows">
        <div class="row">
            <div class="contents-info1">
                <div class="contents-kind">
                    <img src="/{{ posts.category_path }}" width="75" height="25">
                </div>
                <div align="center" class="contents-title">
                    {{posts.title}}
                </div>
                <hr size="10" align="center" width=20% noshade="noshade" />
                <div class="infobox"  align="center">
                    <div class="writerinfo">
                        <a href="{% url 'user_detail' posts.user.IDX %}">
                            <p align="center" size="5" style="color: black;">
                                {% if posts.user.userimage %}
                                <img src="/{{ contents.user.userimage}}" border="0" width="35" height="35" style="border-radius: 25px;">&nbsp {{ posts.user.name }}
                                {% else %}
                                <img src="/static/unid/icon/profle-icon.png" border="0" width="35" height="35">&nbsp {{ post.user.name }}
                                {% endif %}
                            </p>
                        </a>
                    </div>
                    <div class="dateinfo">
                        {{ posts.created_at |timesince }}전
                    </div>
                </div>
            </div>
        </div>
        <!-- preview -->

        <!-- detail of contents -->
        <div class="row">

            <div class="main-detail">
                {% for image in images %}
                <img class="detail-img" src="/{{image.imagepath}}"  width="600px" height="600px">
                {% endfor %}
                <p>{{ posts.contents }}</p>
            </div>
        </div>

        <div class="row">
            <div class="contents-tag">
                <div>
                    <img src="{% static 'unid/icon/tag-icon.png' %}" border="0" width="20" height="20">
                    <span>{{ posts.tags }}</span>
                </div>
            </div>
        </div>

        <!-- replyment -->
        <div class="row">
            <div class="contents-reply">
                <div class="icon-boxs">
                    <div class="icon-box">
                        <span class="main-voting">
                            <button class="votings" name="{{ info.posts_id }}" value="{{voting_count.votingcount }}">
                                <img src="{% static 'unid/icon/heart-icon.png' %}" border="0" width="20" height="20">                              </button>
                            <span class="voting-count" id="voting-{{posts.posts_id}}">{{posts.like_count}}
                            </span>
                        </span>
                    </div>

                <div class="icon-box">
                    <a class="nav-links dropdown-toggle" id="like-list" data-toggle="dropdown">
                    </a>

                    <div class="dropdown-menu">
                        {% for like in likes %}
                        <a class="dropdown-item">
                            {{like.liked_users}}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            <div class="icon-box">
             <span class="main-voting">
                 <img src="{% static 'unid/icon/dollar-icon.png' %}" border="0" width="20" height="20">
                 <span class="rewards" id="reward-{{posts.posts_id}}">{{posts.rewards}}
                 </span>
             </span>
             <span class="main-voting">
                <img src="{% static 'unid/icon/wordballoon-icon.png' %}" border="0" width="20" height="20">
                <span class="reply-count">4
                </span>
             </span>

            </div>
            </div>
            {% if request.session.user_email == posts.user_id %}
                <div class="test icon-box">
                    <img src="{% static 'unid/icon/icons-의견보내기.png' %}" width="90" height="30" class="pointeffect opinion">
                    <a href="{% url 'postmodify' contents.contents_id %}">
                        <img src="{% static 'unid/icon/icons-수정.png' %}" width="75" height="30" >
                    </a>
                    <img src="{% static 'unid/icon/icons-삭제.png' %}" width="75" height="30" class="postdelete pointeffect">
                </div>
                {% else %}
                <div class="icon-box" style="position: relative;left: 160px;">
                    <a href="">
                        <img src="{% static 'unid/icon/icons-의견보내기.png' %}" width="90" height="30" class="pointeffect opinion">
                    </a>
                </div>
                {% endif %}

                <div class="cd-popup2" role="alert">
                    <div class="cd-popup-container2">
                        <div class="popuprow1">
                            <h4>이 게시물에 대한 의견 보내기</h4>
                            회원님의 소중한 의견은 Unid에서 문제를 파악하는데 사용됩니다.
                        </div>
                        <div class="popupcategory">
                            <label for="inputcategory" class="col-sm-3" >카테고리</label>
                            <select class="form-control col-sm-7" id="inputcategory" name="category">
                                <option title="Combo 1">음란물</option>
                                <option title="Combo 2">혐오발언</option>
                                <option title="Combo 3">폭력</option>
                                <option title="Combo 4">허위정보</option>
                                <option title="Combo 5">저작권 위반</option>
                                <option title="Combo 5">기타</option>
                            </select>
                            <input type="text" class="col-sm-11 form-control" id="exception" placeholder="의견을 입력해주세요">
                        </div>
                        <ul class="cd-buttons">
                            <li class="pointeffect"><a href="#0" class="cd-popup-no111">돌아가기</a></li>
                            <li class="pointeffect"><a href="#0" class="cd-popup-postopinion">보내기</a></li>
                        </ul>
                        <a href="#0" class="cd-popup-close img-replace"></a>
                    </div> <!-- cd-popup-container -->
                </div> <!-- cd-popup -->

                <div class="cd-popup1" role="alert">
                    <div class="cd-popup-container1">
                        <div class="popuprow1">
                            <h4>게시글을 삭제하시겠습니까?</h4>
                        </div>

                        <ul class="cd-buttons">
                            <li><a href="#0" class="cd-popup-no">No</a></li>
                            <li><a href="#0" class="cd-popup-delete-yes">Yes</a></li>
                        </ul>
                        <a href="#0" class="cd-popup-close img-replace"></a>
                    </div> <!-- cd-popup-container -->
                </div>
            </div>
        </div>
                <!-- cd-popup -->
         <div class="row">
            <div class="reply-list">
                {% for reply in replys %}
                <div class="reply">
                    <div class="reply-picture">
                        {% if reply.user.name == mypage.name %}
                        <a href="/unid/mypage">
                        {% else %}
                        <a href="{% url 'user_detail' reply.user.IDX %}">
                        {% endif %}
                            {% if reply.user.userimage %}
                                <img src="/{{ reply.writeremail.userimage }}" border="0" width="30" height="30" style="border-radius: 25px;">
                            {% else %}
                                <img src="{% static 'unid/icon/profle-icon.png' %}" border="0" width="30" height="30">
                            {% endif %}
                        </a>
                    </div>
                    <div class="reply-id">
                        {% if reply.user.name == mypage.name %}
                        <a href="/unid/mypage" style="color:black">
                        {% else %}
                        <a href="{% url 'user_detail' reply.writeremail.IDX %}" style="color:black">
                        {% endif %}
                            {{ reply.user_id }}
                        </a>
                    </div>
                    <div class="reply-date">
                        {{ reply.created_at }}
                    </div>
                    <div class="reply-text">
                        {{ reply.replytext }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="row">
            {% if request.session.user_email %}
            <form class="input-reply">
                <textarea rows="5" cols="90" class="form-control" id="inputreplytext" placeholder="댓글을 남겨보세요!"></textarea>
                <input type="button" class="form-control col-sm-2 replybutton pointeffect" value="댓글작성" id="inputreply" repletstyle="margin:0 0 0 600px;">
            </form>
            {% else %}
            <form class="input-reply">
                <textarea rows="5" cols="90" class="form-control" id="inputreplytext" placeholder="유니드계정으로 로그인하고 댓글을 입력해보세요!"></textarea>
                <a href="/unid/login">
                    <input type="button" class="form-control col-sm-2 replybutton pointeffect" value="로그인" id="inputreply" repletstyle="margin:0 0 0 600px;">
                </a>
            </form>
            {% endif %}
        </div>
    </div>
</div>




<script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
<script>
    jQuery(document).ready(function($){
        $('#nav1').addClass('visible-place');
        $(".votings").click(function() {
                var pk = {{posts.posts_id}};
                var like_count = parseInt($('#voting-' + pk).text());
                var rewards = parseFloat($('#reward-' + pk).text());
                var like_users = "{{request.session.user_email}}";
                var voting_count = parseInt($('#count').text());
                var votinged = "";


                if (!like_users) {
                    alert('로그인을 해주세요');
                }


                $.ajax ({
                    type: 'POST',
                    url: "../vote/",
                    data: {
                        posts_id: pk,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(res) {
                        alert(res.Ans);

                        if (res.Ans == "보팅을 취소했습니다.") {

                            if (voting_count >= 10) {
                                like_count = like_count - parseInt(1);
                                votinged = "좋아요취소";

                                $('#voting-' + pk).text(like_count);

                                if (like_count % 1 == 0) {
                                rewards = rewards - parseFloat(0.1);
                                }
                            rewards = rewards.toFixed(1);
                            $("#reward-" + pk).text(rewards);

                            } else {
                                like_count = like_count - parseInt(1);
                                voting_count = voting_count + parseInt(1);

                                votinged = "좋아요취소";


                                $('#voting-' + pk).text(like_count);

                                if (like_count % 1 == 0) {
                                    rewards = rewards - parseFloat(0.1);
                                    }
                                rewards = rewards.toFixed(1);
                                $("#reward-" + pk).text(rewards);
                                $("#count").text(voting_count);
                            }

                        } else if (res.Ans == "보팅을 완료했습니다.") {

                            like_count = like_count + parseInt(1);
                            voting_count = voting_count - parseInt(1);

                            votinged = "좋아요";

                            $('#voting-' + pk).text(like_count);

                            if (like_count % 1 == 0) {
                                rewards = rewards + parseFloat(0.1);
                            }
                            rewards = rewards.toFixed(1);
                            $("#reward-" + pk).text(rewards);
                            $("#count").text(voting_count);
                            }

                         else {
                            votinged = "카운팅소진";
                         }



                        $.ajax({
                            type: 'POST',
                            url: "../voting/",
                            data: {
                                posts_id: pk,
                                like_count: like_count,
                                rewards: rewards,
                                liked_users: like_users,
                                votinged: votinged,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            },
                            success: function(res) {

                            }
                        });

                    }
                });
            });

        $('.postdelete').on('click', function(event) {
            event.preventDefault();
            $('.cd-popup1').addClass('is-visible');
        });
        $('.cd-popup-delete-yes').on('click', function() {
            var id = {{ posts.posts_id }};
            var type = 'info';
            $.ajax({
                type: 'POST',
                url: '../postdelete/',
                data: {
                        id: id,
                        type: type,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(res) {
                    alert(res.Ans);
                    location="{% url 'information' %}";
                    }
                });
            });
        //close popup
        $('.cd-popup1').on('click', function(event){
            if( $(event.target).is('.cd-popup-close') || $(event.target).is('.cd-popup1') || $(event.target).is('.cd-popup-no')) {
                event.preventDefault();
                $(this).removeClass('is-visible');
            }
        });
        //close popup when clicking the esc keyboard button
        $(document).keyup(function(event){
            if(event.which=='27'){
                $('.cd-popup1').removeClass('is-visible');
            }

        });
        //open popup
        $('.opinion').on('click', function(event){
            event.preventDefault();
            let isUser = "{{ request.session.user_email }}"
            if ( !isUser ) {
                alert("로그인이 필요합니다");
                location="{% url 'login' %}"
            } else {
                $('.cd-popup2').addClass('is-visible');
            };
        });
        $('#inputcategory').on('change', function(event) {
            event.preventDefault();
            let isException = $('#inputcategory').val()
            if (isException == "기타") {
                $('#exception').show();
            } else {
                $('#exception').hide();

            };
        });

        $('.cd-popup-postopinion').on('click', function(event){
            event.preventDefault();
            let category = $('#inputcategory').val();
            let exceptOpinion = $('#exception').val();
            let writeremail = "{{ posts.user.email }}";
            let title = "{{ posts.title }}";
            let type = "info";

            $.ajax({
                type: 'POST',
                url: '../opinion/',
                data: {
                    id: {{ posts.posts_id }},
                    category: category,
                    exceptOpinion: exceptOpinion,
                    writeremail: writeremail,
                    title: title,
                    type: type,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                success : function(res) {
                    alert(res.Ans);
                    $('.cd-popup2').removeClass('is-visible');
                    }
                });
            });

        //close popup
        $('.cd-popup2').on('click', function(event){
            if( $(event.target).is('.cd-popup-close') || $(event.target).is('.cd-popup2') || $(event.target).is('.cd-popup-no')) {
                event.preventDefault();
                $(this).removeClass('is-visible');
            }
        });
        //close popup when clicking the esc keyboard button
        $(document).keyup(function(event){
            if(event.which=='27'){
                $('.cd-popup2').removeClass('is-visible');
            }

        });

        //open popup
        $('.cd-popup-trigger').on('click', function(event){
            event.preventDefault();
            $('.cd-popup').addClass('is-visible');

        });

        //close popup
        $('.cd-popup').on('click', function(event){
            if( $(event.target).is('.cd-popup-close') || $(event.target).is('.cd-popup') || $(event.target).is('.cd-popup-no')) {
                event.preventDefault();
                $(this).removeClass('is-visible');
            }
        });
        //close popup when clicking the esc keyboard button
        $(document).keyup(function(event){
            if(event.which=='27'){
                $('.cd-popup').removeClass('is-visible');
            }

        });
        $('#inputreply').on('click', function() {
            var isUser = "{{ request.session.user_email }}";
            if ( !isUser ) {
                alert("로그인이 필요합니다");
                location="{% url 'login' %}"
            }
            var reply = $('#inputreplytext').val();
            var posts_id = {{ posts.posts_id }};
            console.log(posts_id)
            $.ajax({
                type: 'POST',
                url: '../mainreply/',
                data: {
                    id: posts_id,
                    reply: reply,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                success : function(res) {
                    alert(res.Ans);
                    var user= res.user;
                    var created_at = res.created_at;
                    var replytext= res.replytext;
                    $('#inputreplytext').val("");
                    $('.reply-list').append(`
                                       <div class="reply">
                                            <div class="reply-picture">
                                                <img src="{% static 'unid/icon/profle-icon.png' %}" border="0" width="30" height="30">
                                            </div>
                                            <div class="reply-id">
                                                ${user}
                                            </div>
                                            <div class="reply-date">
                                                ${created_at}
                                            </div>
                                            <div class="reply-text">
                                                ${replytext}
                                            </div>
                                        </div>
                                `);

                }
            });
        });

    });
</script>
{% endblock %}

