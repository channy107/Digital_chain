{% extends 'unid/navigationbar.html' %}
{% load static %}
{% block content %}
<!-- Page Content -->

<link href="{% static 'unid/css/mywallet.css' %}" rel="stylesheet">

<div class="container1">
    <!-- contents InFo -->
    <div class="rows">
        <div class="row">
            <div class="contents-info">
                    <h5 class="contents-title">
                        <b>  내 지갑 </b>
                    </h5>

                    <h4 class="contents-title2" align="right">
                        <img src="{% static 'unid/icon/key.png' %}" border="0" width="25" height="25">
                        <img src="{% static 'unid/icon/line-graph.png' %}" border="0" width="25" height="25">
                    </h4>
                </br>
                </br>
                <hr size="10" align="center" width=100% noshade="noshade" color="#efefef"  />
                    <div id="Status_account">
                    {% if request.session.user_name %}
                    <p align="center" size ="5"> {{ request.session.user_name }} 님의 보유자산 </p>
                    {% endif %}
                    </div>
                <p align="center" size ="100"><img src="{% static 'unid/icon/wallet.png' %}" border="0" width="230" height="230">  </p>
                    <div id="Status_balance">
                    </div>
                </br>
                </br>
                <div class="function-button">
                        <a href="http://127.0.0.1:8000/unid/transaction/"> <img src="{% static 'unid/icon/credit-card.png' %}" border="0" width="100" height="100"></a>
                    <br>
                        <span class="icon-name" size="5">전송</span>
                </div>
                <div class="function-button">
                        <img src="{% static 'unid/icon/exchange.png' %}" border="0" width="100" height="100">
                    <br>
                        <span class="icon-name" size="5">환전</span>
                </div>
                <div class="function-button">
                        <img src="{% static 'unid/icon/bill.png' %}" border="0" width="100" height="100">
                    <br>
                        <span class="icon-name"  size="5">구매</span>
                </div>

            </div>
        </div>

        </br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br>


        <!-- search bar -->
        <div class="box">
             <div class="container-2">
                 <div class="icon-box">
                    <span class="icon"><i class="fa fa-search"></i></span>
                 </div>
                 <div class="text-box">
                    <input type="search" id="search" placeholder="Search..." />
                 </div>
              </div>
        </div>
        <!-- history -->
        <div class="row">
            <div class="history">
                <div>
                    <span>보상내역</span>
                    <span>6건</span>
                </div>
                <div>
                    <div class="history-total">
                    <div>
                        <span>total</span> <span>10.4nid</span>
                    </div>
                    <div>
                        <span>(+3.4)</span>
                    </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- history-detail -->
        <div class="row">
            <div class="history-detail">
                2018.11.20   &nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/warning.png' %}" border="0" width="20" height="20">
                3.4nid
                <span class="history-name" > 한양대 교양중 제일 재미있는 교양 추천의 보상</span>
            </div>
        </div>
        <div class="row">
            <div class="history-detail">
                2018.11.20   &nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/warning.png' %}" border="0" width="20" height="20">
                3.4nid
                <span class="history-name" > 한양대 교양중 제일 재미있는 교양 추천의 보상</span>
            </div>
        </div>
        <div class="row">
            <div class="history-detail">
                2018.11.20   &nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/success.png' %}" border="0" width="20" height="20">
                3.4nid
                <span class="history-name" > 한양대 교양중 제일 재미있는 교양 추천의 보상</span>
            </div>
        </div>
        <div class="row">
            <div class="history-detail">
                2018.11.20   &nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/success.png' %}" border="0" width="20" height="20">
                3.4nid
                <span class="history-name" > 한양대 교양중 제일 재미있는 교양 추천의 보상</span>
            </div>
        </div>
        </br>
        </br>
        <!-- history -->
        <div class="row">
            <div class="history">
                <div>
                    <span>거래내역</span>
                    <span>6건</span>
                </div>
            </div>
        </div>

        <!-- history-detail -->
        <div class="row">
            <div class="history-detail">
                2018.11.20 &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> gorapapa </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> kingsori </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/dollar.png' %}" border="0" width="18" height="18">
                <span> 32nid </span>
                <span class="history-name" > 0x3i4kl4hi3oief56i4h4oi</span>
            </div>
        </div>
        <div class="row">
            <div class="history-detail">
                2018.11.20 &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> gorapapa </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> kingsori </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/dollar.png' %}" border="0" width="18" height="18">
                <span> 32nid </span>
                <span class="history-name" > 0x3i4kl4hi3oief56i4h4oi</span>
            </div>
        </div>
        <div class="row">
            <div class="history-detail">
                2018.11.20 &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> gorapapa </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> kingsori </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/dollar.png' %}" border="0" width="18" height="18">
                <span> 32nid </span>
                <span class="history-name" > 0x3i4kl4hi3oief56i4h4oi</span>
            </div>
        </div>
        <div class="row">
            <div class="history-detail">
                2018.11.20 &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> gorapapa </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/user.png' %}" border="0" width="18" height="18">
                <span> kingsori </span> &nbsp&nbsp&nbsp&nbsp
                <img src="{% static 'unid/icon/dollar.png' %}" border="0" width="18" height="18">
                <span> 32nid </span>
                <span class="history-name" > 0x3i4kl4hi3oief56i4h4oi</span>
            </div>
        </div>
    </div>

</div>

       <!--<div class="container">-->
           <!--&lt;!&ndash; 제목 &ndash;&gt;-->
           <!--<div class="row">-->
               <!--<h1>ETHER Wallet</h1>-->
           <!--</div>-->
           <!--&lt;!&ndash; 계좌 잔고 출력 &ndash;&gt;-->
           <!--<div class="row">-->
               <!--<div id="divStatus">-->
               <!--</div>-->
           <!--</div>-->
           <!--&lt;!&ndash; 송금 입력 창 &ndash;&gt;-->
           <!--<div class="row">-->
               <!--<div class="input-group">-->
                   <!--<label class="input-group-text" for="fromAccounts">보내는 사람</label>-->
                   <!--<select class="form-control accountsList" id="fromAccounts">-->
                       <!--<option selected>선택하세요.</option>-->
                   <!--</select>-->
               <!--</div>-->
               <!--<div class="input-group">-->
                   <!--<label class="input-group-text" for="fromPassword">패스워드</label>-->
                   <!--<input class="form-control" id="fromPassword" type="password" />-->
               <!--</div>-->
               <!--<div class="input-group">-->
                   <!--<label class="input-group-text" for="toAccounts">받는 사람</label>-->
                   <!--<select class="form-control accountsList" id="toAccounts">-->
                       <!--<option selected>선택하세요.</option>-->
                   <!--</select>-->
               <!--</div>-->
               <!--<div class="input-group">-->
                   <!--<label class="input-group-text" for="amount">송금액</label>-->
                   <!--<input class="form-control" id="amount" type="number" />-->
                   <!--<div class="input-group-append">-->
                       <!--<span class="input-group-text">ETHER</span>-->
                       <!--<button type="button" class="btn btn-primary" id="btnSend">송금</button>-->
                   <!--</div>-->
               <!--</div>-->
           <!--</div>-->
       <!--</div>-->



       <script>
           var WEB3 = require('web3');
           var web3 = new WEB3();
           web3.setProvider(new web3.providers.HttpProvider("http://localhost:8545"));

           var _supply = 10000;
           var _name = "NidCoin";
           var _symbol = "nid";
           var _decimals = 0;
           var NidCoinContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"int256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"int256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"int256"}],"name":"transfer","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_supply","type":"int256"},{"name":"_name","type":"string"},{"name":"_symbol","type":"string"},{"name":"_decimals","type":"uint8"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"int256"}],"name":"EvtTransfer","type":"event"}]);

           var nd = NidCoinContract.at( "0xdb5e616615330b3ebefc41d547d109579900ca70" );

           // 계정 정보를 조회해서 보내는 사람과 받는 사람 선택창에 설정
           function setAccountsList() {
               let accounts = web3.eth.accounts;
               accounts.forEach(account => {
                   $('.accountsList').append(`
                       <option value="${account}">
                           ${account.substr(0,6)}...${account.substr(-4)}
                       </option>
                   `);
               });
           }

           // 계정별 잔액을 출력
           function showStatus() {

               <!--let statusAccount = `-->
                    <!--<p id="ac" align="center" size ="5"></p>-->
               <!--`;-->

               let statusBalance =`
                   <h4 align="center" size ="5"> nid </h4>
                   <h4 id="ba" align="center" size ="5"></h4>
                `;

               <!--$('#Status_account').empty();-->
               <!--$('#Status_account').append(statusAccount);-->

               $('#Status_balance').empty();
               $('#Status_balance').append(statusBalance);

               let totalAmount = 0;
               let accounts = web3.eth.accounts;
               let account = {{ request.session.user_account }};
               let balance = parseFloat(web3.fromWei(web3.eth.getBalance(account), "ether"));
               totalAmount += balance;
               <!--$("#ac").append(`${account}의 보유자산`);-->
               <!--$('#ba').append(`${balance}eth`);-->
               $('#ba').append(`${account}`);


           }

           $(function() {
               setAccountsList();
               showStatus();

               // 블록에 변화가 생겼을 때 계정별 잔액 정보를 갱신
               web3.eth.filter('latest').watch(function() {
                   showStatus();
               });

               // 송금 버튼을 클릭했을 때, 송금을 요청
               $('#btnSend').click(function() {
                   let fromAccount  = $('#fromAccounts').val();
                   let toAccount    = $('#toAccounts').val();
                   let fromPassword = $('#fromPassword').val();
                   let amount       = $('#amount').val();

                   // 보내는 사람의 계정을 언락
                   let isUnlock = web3.personal.unlockAccount(fromAccount, fromPassword);
                   if (isUnlock) {
                       web3.eth.sendTransaction({
                           from : fromAccount,
                           to   : toAccount,
                           value: web3.toWei(amount, "ether")
                       }, function(err, res) {
                           if (!err) {
                               console.log(`txid is ${res}.`);
                           } else {
                               console.error(err);
                           }
                       });
                   }
               });
           });
       </script>

{% endblock %}

